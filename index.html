<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TieBio</title>
   <link rel="stylesheet" href="catuaba.css">

</head>
<body>
  <!-- Header -->
  <header class="main-header">
    <div class="header-content">

<div class="logo-section">
  <a href="#" class="logo">
 <!--   <img src="https://github.com/shitcoinheiros/link-em-cadeia/blob/main/Logo%20TIEBIO.png?raw=true" alt="Logo TieBIO" class="logo-icon">  -->
    <div class="logo-text">TieBio</div>
  </a>
</div>
      

    

    
      
      <div class="wallet-section">
        <div class="network-selector">
          <div class="network-logo" id="networkLogo">
            <img src="https://assets.coingecko.com/coins/images/825/small/bnb-icon2_2x.png" alt="BNB Chain">
          </div>
          <div class="network-dropdown" id="networkDropdown">
            <div class="network-option active" data-chain="bsc">
              <div class="network-option-icon">
                <img src="https://assets.coingecko.com/coins/images/825/small/bnb-icon2_2x.png" alt="BNB Chain">
              </div>
              <div class="network-option-name">BNB Chain</div>
            </div>
            <div class="network-option" data-chain="ethereum">
              <div class="network-option-icon">
                <img src="https://assets.coingecko.com/coins/images/279/small/ethereum.png" alt="Ethereum">
              </div>
              <div class="network-option-name">Ethereum</div>
            </div>
            <div class="network-option" data-chain="polygon">
              <div class="network-option-icon">
                <img src="https://assets.coingecko.com/coins/images/4713/small/matic-token-icon.png" alt="Polygon">
              </div>
              <div class="network-option-name">Polygon</div>
            </div>
            <div class="network-option" data-chain="base">
              <div class="network-option-icon">
                <img src="https://altcoinsbox.com/wp-content/uploads/2023/02/base-logo-in-blue.webp" alt="Base">
              </div>
              <div class="network-option-name">Base</div>
            </div>
            <div class="network-option" data-chain="avalanche">
              <div class="network-option-icon">
                <img src="https://assets.coingecko.com/coins/images/12559/small/Avalanche_Circle_RedWhite_Trans.png" alt="Avalanche">
              </div>
              <div class="network-option-name">Avalanche</div>
            </div>
          </div>
        </div>
        <span id="walletAddr" class="wallet-address">não conectado</span>
        <button id="connectBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13 9H21V11H13V9ZM13 13H21V15H13V13ZM13 17H21V19H13V17ZM4 19H10V21H4C2.9 21 2 20.1 2 19V5C2 3.9 2.9 3 4 3H10V5H4V19ZM7 11H9V9H7V11ZM7 15H9V13H7V15ZM7 19H9V17H7V19Z" fill="currentColor"/>
          </svg>
          Conectar
        </button>
      </div>
    </div>
  </header>

  <!-- Modal de Conexão -->
  <div class="modal" id="walletModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Conectar Carteira</h2>
        <button class="close-modal" id="closeModal">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z" fill="currentColor"/>
          </svg>
        </button>
      </div>
      <div class="wallet-options">
        <div class="wallet-option" id="metamaskOption">
          <div class="wallet-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21 7L12 14L3 7V5L12 12L21 5V7Z" fill="#F6851B"/>
            </svg>
          </div>
          <div class="wallet-name">MetaMask</div>
        </div>
        <div class="wallet-option" id="walletconnectOption">
          <div class="wallet-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2Z" fill="#3B99FC"/>
            </svg>
          </div>
          <div class="wallet-name">WalletConnect</div>
        </div>
        <div class="wallet-option" id="binanceOption">
          <div class="wallet-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2Z" fill="#F0B90B"/>
            </svg>
          </div>
          <div class="wallet-name">Binance Chain</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="main-content">
    <div class="card">
      <div class="page-header">
        <h1 class="page-title">Criar / Editar Perfil</h1>
        <p class="page-subtitle">Gerencie sua identidade Web3 na blockchain</p>
      </div>

      <div class="grid">
        <div>
          <div class="form-section">
            <label for="name">Nome</label>
            <input id="name" type="text" placeholder="Seu nome público (ex: @william)" />
          </div>

          <div class="form-section">
            <label for="description">Descrição</label>
            <textarea id="description" placeholder="Fale um pouco sobre você, seus interesses, projetos... (máx. 500 caracteres)" maxlength="500"></textarea>
            <div class="small" style="text-align: right; margin-top: 4px;">
              <span id="charCount">0</span>/500 caracteres
            </div>
          </div>

          <div class="form-section">
            <label for="photo">Foto (URL)</label>
            <input id="photo" type="text" placeholder="https://.../avatar.jpg" />
          </div>

          <div class="form-section" id="linksBox">
            <label>Links (rede social, site, etc.)</label>
            <div id="linksList"></div>
            <div style="margin-top:12px">
              <button id="addLinkBtn" type="button" class="secondary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z" fill="currentColor"/>
                </svg>
                Adicionar link
              </button>
            </div>
          </div>

          <!-- Bloco informativo - versão desktop -->
          <div class="muted-block small desktop-text">
            Personalize sua página e veja as mudanças ao vivo no painel à direita.
          </div>

          <div class="actions">
            <button id="saveBtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M17 3H5C3.89 3 3 3.9 3 5V19C3 20.1 3.89 21 5 21H19C20.1 21 21 20.1 21 19V7L17 3ZM12 19C10.34 19 9 17.66 9 16C9 14.34 10.34 13 12 13C13.66 13 15 14.34 15 16C15 17.66 13.66 19 12 19ZM15 9H5V5H15V9Z" fill="currentColor"/>
              </svg>
              Salvar na blockchain
            </button>
            <button id="previewBtn" type="button" class="secondary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 4.5C7 4.5 2.73 7.61 1 12C2.73 16.39 7 19.5 12 19.5C17 19.5 21.27 16.39 23 12C21.27 7.61 17 4.5 12 4.5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z" fill="currentColor"/>
              </svg>
              Abrir página pública
            </button>
          </div>
        </div>

        <aside>
          <div class="profile-preview" id="previewBox">
            <div class="avatar">
              <div class="avatar-placeholder" id="avatarPlaceholder">Adicione uma URL de imagem</div>
              <img id="avatarImg" src="" alt="avatar" style="width:100%;height:100%;object-fit:cover;display:none"/>
            </div>
            <div style="margin-top:12px;text-align:center">
              <div id="previewName" style="font-weight:700;font-size:20px">Nome</div>
              <div id="previewAddr" class="small" style="margin-top:4px">endereço</div>
            </div>
            <div class="preview-description" id="previewDescription">
              Sua descrição aparecerá aqui...
            </div>
            <div class="links" id="previewLinks"></div>
          </div>
          
          <!-- Bloco informativo - versão mobile -->
          <div class="muted-block small mobile-text">
            Personalize sua página e veja as mudanças ao vivo no painel acima.
          </div>
          
          <div style="margin-top:16px;font-size:14px;color:var(--text-secondary);font-weight:500">Link público (após salvar):</div>
          <div id="publicLink" class="small" style="word-break:break-all;margin-top:6px;padding:10px;background:rgba(240,185,11,0.03);border-radius:var(--radius-md);border:1px solid var(--border-light)">—</div>
        </aside>
      </div>

      <footer>
        <div class="network-info">
          <div class="network-indicator"></div>
          <div class="small">Rede: <span id="networkName">—</span></div>
        </div>
        <div class="small">Linkchain • DApp de Perfil Web3</div>
      </footer>
    </div>
  </main>

  <!-- Footer Mobile -->
  <footer class="mobile-footer">
    <nav class="mobile-nav">
      <a href="#" class="mobile-nav-item active">
        <div class="mobile-nav-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 20V14H14V20H19V12H22L12 3L2 12H5V20H10Z" fill="currentColor"/>
          </svg>
        </div>
        <span>Início</span>
      </a>
      <a href="#" class="mobile-nav-item">
        <div class="mobile-nav-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20Z" fill="currentColor"/>
            <path d="M12 17C14.7614 17 17 14.7614 17 12C17 9.23858 14.7614 7 12 7C9.23858 7 7 9.23858 7 12C7 14.7614 9.23858 17 12 17Z" fill="currentColor"/>
          </svg>
        </div>
        <span>Explorar</span>
      </a>
      <a href="#" class="mobile-nav-item">
        <div class="mobile-nav-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2ZM18 20H6V4H13V9H18V20Z" fill="currentColor"/>
          </svg>
        </div>
        <span>Docs</span>
      </a>
      <a href="#" class="mobile-nav-item">
        <div class="mobile-nav-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM20 16H5.17L4 17.17V4H20V16Z" fill="currentColor"/>
            <path d="M7 9H17V11H7V9ZM7 12H15V14H7V12Z" fill="currentColor"/>
          </svg>
        </div>
        <span>Suporte</span>
      </a>
    </nav>
  </footer>

  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.min.js";

    // Configurações das redes blockchain
    const NETWORKS = {
      bsc: {
        chainId: "0x38",
        chainName: "Binance Smart Chain",
        rpcUrls: ["https://bsc-dataseed.binance.org/"],
        nativeCurrency: { name: "BNB", symbol: "BNB", decimals: 18 },
        blockExplorerUrls: ["https://bscscan.com"]
      },
      bscTestnet: {
        chainId: "0x61",
        chainName: "Binance Smart Chain Testnet",
        rpcUrls: ["https://data-seed-prebsc-1-s1.binance.org:8545/"],
        nativeCurrency: { name: "tBNB", symbol: "tBNB", decimals: 18 },
        blockExplorerUrls: ["https://testnet.bscscan.com"]
      },
      ethereum: {
        chainId: "0x1",
        chainName: "Ethereum Mainnet",
        rpcUrls: ["https://mainnet.infura.io/v3/"],
        nativeCurrency: { name: "Ether", symbol: "ETH", decimals: 18 },
        blockExplorerUrls: ["https://etherscan.io"]
      },
      polygon: {
        chainId: "0x89",
        chainName: "Polygon Mainnet",
        rpcUrls: ["https://polygon-rpc.com/"],
        nativeCurrency: { name: "MATIC", symbol: "MATIC", decimals: 18 },
        blockExplorerUrls: ["https://polygonscan.com"]
      },
      base: {
        chainId: "0x2105",
        chainName: "Base Mainnet",
        rpcUrls: ["https://mainnet.base.org/"],
        nativeCurrency: { name: "Ether", symbol: "ETH", decimals: 18 },
        blockExplorerUrls: ["https://basescan.org"]
      },
      avalanche: {
        chainId: "0xA86A",
        chainName: "Avalanche Mainnet",
        rpcUrls: ["https://api.avax.network/ext/bc/C/rpc"],
        nativeCurrency: { name: "AVAX", symbol: "AVAX", decimals: 18 },
        blockExplorerUrls: ["https://snowtrace.io"]
      }
    };

    const CONTRACT_ADDRESS = "0xab93225dbf590478b4487bf1bf577db629aa6bee";
    const ABI = [
      "function setProfile(string calldata json) external",
      "function getProfile(address user) public view returns (string memory)",
      "event ProfileUpdated(address indexed user, string json)"
    ];

    // Elementos do DOM
    const connectButton = document.getElementById("connectBtn");
    const walletAddressSpan = document.getElementById("walletAddr");
    const nameInput = document.getElementById("name");
    const descriptionInput = document.getElementById("description");
    const photoInput = document.getElementById("photo");
    const addLinkButton = document.getElementById("addLinkBtn");
    const linksList = document.getElementById("linksList");
    const previewName = document.getElementById("previewName");
    const previewAddr = document.getElementById("previewAddr");
    const previewDescription = document.getElementById("previewDescription");
    const avatarImg = document.getElementById("avatarImg");
    const previewLinks = document.getElementById("previewLinks");
    const saveButton = document.getElementById("saveBtn");
    const networkName = document.getElementById("networkName");
    const previewButton = document.getElementById("previewBtn");
    const avatarPlaceholder = document.getElementById("avatarPlaceholder");
    const charCount = document.getElementById("charCount");
    const walletModal = document.getElementById("walletModal");
    const closeModal = document.getElementById("closeModal");
    const networkLogo = document.getElementById("networkLogo");
    const networkDropdown = document.getElementById("networkDropdown");

    let signer = null;
    let userAddress = null;
    let currentNetwork = "bsc";

    // Detectar se é dispositivo móvel
    const isMobileDevice = () => /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    // Configuração do seletor de redes
    networkLogo.addEventListener("click", (event) => {
      event.stopPropagation();
      networkDropdown.classList.toggle("active");
    });

    // Fechar dropdown ao clicar fora
    document.addEventListener("click", (event) => {
      if (!networkLogo.contains(event.target) && !networkDropdown.contains(event.target)) {
        networkDropdown.classList.remove("active");
      }
    });

    // Selecionar rede
    document.querySelectorAll(".network-option").forEach((option) => {
      option.addEventListener("click", async () => {
        const chain = option.getAttribute("data-chain");
        
        // Atualizar estado ativo visual
        document.querySelectorAll(".network-option").forEach((opt) => {
          opt.classList.remove("active");
        });
        option.classList.add("active");
        
        // Atualizar logo principal
        const logoImage = option.querySelector("img").src;
        networkLogo.querySelector("img").src = logoImage;
        
        // Fechar dropdown
        networkDropdown.classList.remove("active");
        
        // Mudar rede na carteira se estiver conectado
        if (window.ethereum && signer) {
          try {
            await switchNetwork(chain);
            currentNetwork = chain;
            updateNetworkInfo();
          } catch (error) {
            console.error("Erro ao mudar de rede:", error);
            alert("Erro ao mudar para a rede selecionada. Verifique se sua carteira suporta esta rede.");
          }
        } else {
          currentNetwork = chain;
          updateNetworkInfo();
        }
      });
    });

    // Função para mudar de rede na carteira
    async function switchNetwork(chain) {
      if (!window.ethereum) {
        throw new Error("Carteira não detectada");
      }

      const networkConfig = NETWORKS[chain];
      if (!networkConfig) {
        throw new Error("Rede não suportada");
      }

      try {
        // Tentar mudar para a rede
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: networkConfig.chainId }]
        });
      } catch (switchError) {
        // Se a rede não estiver adicionada, adicioná-la
        if (switchError.code === 4902) {
          try {
            await window.ethereum.request({
              method: "wallet_addEthereumChain",
              params: [networkConfig]
            });
          } catch (addError) {
            throw new Error("Não foi possível adicionar a rede à carteira");
          }
        } else {
          throw switchError;
        }
      }
    }

    // Atualizar informações da rede na interface
    function updateNetworkInfo() {
      const networkNames = {
        "bsc": "BNB Chain",
        "bscTestnet": "BSC Testnet", 
        "ethereum": "Ethereum",
        "polygon": "Polygon",
        "base": "Base",
        "avalanche": "Avalanche"
      };
      
      networkName.textContent = networkNames[currentNetwork] || "Rede Desconhecida";
    }

    // Modal de conexão
    connectButton.onclick = () => {
      if (!signer) {
        walletModal.style.display = "flex";
        void walletModal.offsetWidth;
      } else {
        disconnectWallet();
      }
    };

    closeModal.onclick = () => {
      walletModal.style.display = "none";
    };

    // Fechar modal ao clicar fora
    window.onclick = (event) => {
      if (event.target === walletModal) {
        walletModal.style.display = "none";
      }
    };

    // Opções de carteira no modal
    document.getElementById("metamaskOption").onclick = connectWallet;
    document.getElementById("walletconnectOption").onclick = () => alert("WalletConnect em breve!");
    document.getElementById("binanceOption").onclick = () => alert("Binance Chain em breve!");

    // Conectar carteira
    async function connectWallet() {
      if (window.ethereum) {
        try {
          // Solicitar conexão da carteira
          await window.ethereum.request({ method: "eth_requestAccounts" });
          
          // Configurar provedor Ethers
          const provider = new ethers.BrowserProvider(window.ethereum);
          signer = await provider.getSigner();
          userAddress = await signer.getAddress();
          
          // Atualizar interface
          walletAddressSpan.textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
          previewAddr.textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
          
          // Obter informações da rede
          const network = await provider.getNetwork();
          currentNetwork = getNetworkFromChainId(network.chainId);
          updateNetworkInfo();
          
          // Atualizar botão de conexão
          connectButton.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M17 7L15.59 8.41L18.17 11H8V13H18.17L15.59 15.58L17 17L22 12L17 7ZM4 5H12V3H4C2.9 3 2 3.9 2 5V19C2 20.1 2.9 21 4 21H12V19H4V5Z" fill="currentColor"/>
            </svg>
            Desconectar
          `;
          
          // Fechar modal
          walletModal.style.display = "none";
          
          // Carregar perfil se existir
          await loadProfileOnChain(userAddress, provider);
          
        } catch (error) {
          console.error("Erro ao conectar:", error);
          alert("Erro ao conectar carteira: " + error.message);
        }
      } else {
        if (isMobileDevice()) {
          // Deep link para MetaMask em dispositivos móveis
          const deepLink = `https://metamask.app.link/dapp/${window.location.host}${window.location.pathname}`;
          window.location.href = deepLink;
        } else {
          alert("MetaMask não encontrada. Por favor, instale a MetaMask para continuar.");
        }
      }
    }

    // Obter nome da rede a partir do chainId
    function getNetworkFromChainId(chainId) {
      const chainIdHex = "0x" + chainId.toString(16);
      
      const chainIdMap = {
        "0x1": "ethereum",
        "0x38": "bsc", 
        "0x61": "bscTestnet",
        "0x89": "polygon",
        "0x2105": "base",
        "0xA86A": "avalanche"
      };
      
      return chainIdMap[chainIdHex] || "unknown";
    }

    // Desconectar carteira
    function disconnectWallet() {
      signer = null;
      userAddress = null;
      walletAddressSpan.textContent = "não conectado";
      connectButton.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M13 9H21V11H13V9ZM13 13H21V15H13V13ZM13 17H21V19H13V17ZM4 19H10V21H4C2.9 21 2 20.1 2 19V5C2 3.9 2.9 3 4 3H10V5H4V19ZM7 11H9V9H7V11ZM7 15H9V13H7V15ZM7 19H9V17H7V19Z" fill="currentColor"/>
        </svg>
        Conectar
      `;
    }

    // Obter dados dos links
    const getLinksData = () => Array.from(linksList.querySelectorAll(".link-item"))
      .map((element) => ({ 
        label: element.querySelector('input[placeholder*="rótulo"]').value, 
        url: element.querySelector('input[placeholder*="https"]').value 
      }))
      .filter((link) => link.url);

    // Renderizar preview
    function renderPreview() {
      previewName.textContent = nameInput.value || "Seu nome";
      
      // Atualizar descrição
      const descriptionText = descriptionInput.value || "Sua descrição aparecerá aqui...";
      previewDescription.textContent = descriptionText;
      
      // Atualizar avatar
      if (photoInput.value) {
        avatarImg.src = photoInput.value;
        avatarImg.style.display = "block";
        avatarPlaceholder.style.display = "none";
      } else {
        avatarImg.style.display = "none";
        avatarPlaceholder.style.display = "block";
      }
      
      // Atualizar links
      previewLinks.innerHTML = "";
      for (const link of getLinksData()) {
        const anchor = document.createElement("a");
        anchor.href = link.url;
        anchor.textContent = link.label;
        anchor.target = "_blank";
        anchor.style.color = "var(--accent-primary)";
        anchor.style.display = "block";
        anchor.style.margin = "8px 0";
        anchor.style.textDecoration = "none";
        anchor.style.fontWeight = "600";
        anchor.style.transition = ".2s";
        anchor.style.padding = "8px 12px";
        anchor.style.borderRadius = "var(--radius-md)";
        anchor.style.backgroundColor = "rgba(240, 185, 11, 0.1)";
        anchor.onmouseover = () => {
          anchor.style.backgroundColor = "rgba(240, 185, 11, 0.2)";
          anchor.style.transform = "translateY(-2px)";
        };
        anchor.onmouseout = () => {
          anchor.style.backgroundColor = "rgba(240, 185, 11, 0.1)";
          anchor.style.transform = "translateY(0)";
        };
        previewLinks.appendChild(anchor);
      }
    }

    // Adicionar item de link
    function addLinkItem(label = "", url = "") {
      const div = document.createElement("div");
      div.className = "link-item";
      
      const labelInput = document.createElement("input");
      labelInput.placeholder = "rótulo (ex: Twitter)";
      labelInput.value = label;
      
      const urlInput = document.createElement("input");
      urlInput.placeholder = "https://...";
      urlInput.value = url;
      
      const rowDiv = document.createElement("div");
      rowDiv.className = "link-item-row";
      rowDiv.append(labelInput, urlInput);
      
      const deleteButton = document.createElement("button");
      deleteButton.innerHTML = `
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z" fill="currentColor"/>
        </svg>
        Remover
      `;
      deleteButton.onclick = () => { div.remove(); renderPreview(); };
      
      div.append(rowDiv, deleteButton);
      linksList.appendChild(div);
      
      labelInput.oninput = urlInput.oninput = renderPreview;
      renderPreview();
    }

    addLinkButton.onclick = () => addLinkItem();
    addLinkItem("Website", "https://");

    [nameInput, descriptionInput, photoInput].forEach((element) => element.oninput = renderPreview);

    // Contador de caracteres para a descrição
    descriptionInput.addEventListener("input", () => {
      const count = descriptionInput.value.length;
      charCount.textContent = count;
      
      if (count > 450) {
        charCount.style.color = "var(--warning)";
      } else {
        charCount.style.color = "var(--text-muted)";
      }
      
      if (count >= 500) {
        charCount.style.color = "var(--danger)";
      }
    });

    // Salvar perfil na blockchain
    async function saveProfile() {
      if (!signer) {
        walletModal.style.display = "flex";
        void walletModal.offsetWidth;
        return;
      }
      
      const profile = { 
        name: nameInput.value, 
        description: descriptionInput.value,
        photo: photoInput.value, 
        links: getLinksData() 
      };
      
      const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
      
      try {
        const transaction = await contract.setProfile(JSON.stringify(profile));
        alert("Confirme a transação na sua carteira.");
        await transaction.wait();
        alert("Perfil salvo com sucesso na blockchain!");
      } catch (error) { 
        alert("Erro ao salvar perfil: " + error.message); 
      }
    }
    
    saveButton.onclick = saveProfile;

    previewButton.onclick = () => {
      if (!userAddress) {
        alert("Conecte sua carteira antes de abrir a página pública.");
        walletModal.style.display = "flex";
        void walletModal.offsetWidth;
        return;
      }
      const url = `profile.html?addr=${userAddress}`;
      window.open(url, "_blank");
    };

    // Carregar perfil da blockchain
    async function loadProfileOnChain(address, provider) {
      const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
      
      try {
        const jsonData = await contract.getProfile(address);
        if (jsonData) {
          const profileObject = JSON.parse(jsonData);
          nameInput.value = profileObject.name || "";
          descriptionInput.value = profileObject.description || "";
          photoInput.value = profileObject.photo || "";
          linksList.innerHTML = "";
          (profileObject.links || []).forEach((link) => addLinkItem(link.label, link.url));
          renderPreview();
          
          // Atualizar contador de caracteres
          charCount.textContent = descriptionInput.value.length;
        }
      } catch (error) { 
        console.log("Erro ao carregar perfil:", error); 
      }
    }

    // Inicializar preview
    renderPreview();
    updateNetworkInfo();
  </script>
</body>
</html>
