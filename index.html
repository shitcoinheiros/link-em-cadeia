<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Linkchain — Criar perfil</title>
  <style>
    :root {
      --bg-primary: #0B0E11;
      --bg-secondary: #161A1E;
      --bg-card: rgba(22, 26, 30, 0.9);
      --bg-gradient: linear-gradient(135deg, #0B0E11 0%, #1A1D23 100%);
      --accent-primary: #F0B90B;
      --accent-secondary: #F8D33A;
      --accent-gradient: linear-gradient(135deg, #F0B90B 0%, #F8D33A 100%);
      --text-primary: #EAECEF;
      --text-secondary: #B7BDC6;
      --text-muted: #848E9C;
      --border-light: rgba(240, 185, 11, 0.1);
      --border-medium: rgba(240, 185, 11, 0.15);
      --border-accent: rgba(240, 185, 11, 0.3);
      --success: #0ECB81;
      --warning: #F0B90B;
      --danger: #F6465D;
      --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.6);
      --shadow-xl: 0 20px 40px -10px rgba(0, 0, 0, 0.7);
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --radius-xl: 20px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      margin: 0;
      min-height: 100vh;
      background: var(--bg-gradient);
      color: var(--text-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      line-height: 1.6;
    }

    .card {
      width: 100%;
      max-width: 980px;
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      border-radius: var(--radius-xl);
      padding: 32px;
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--border-light);
      transition: all 0.3s ease;
    }

    .card:hover {
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
      border-color: var(--border-accent);
    }

    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 28px;
      gap: 16px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-light);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: var(--accent-primary);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      color: #0B0E11;
    }

    h1 {
      font-size: 24px;
      margin: 0;
      font-weight: 700;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .wallet-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .wallet-address {
      font-size: 14px;
      color: var(--text-secondary);
      background: rgba(11, 14, 17, 0.8);
      padding: 8px 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    button {
      background: var(--accent-primary);
      border: none;
      padding: 12px 20px;
      border-radius: var(--radius-md);
      color: #0B0E11;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 6px rgba(240, 185, 11, 0.25);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(240, 185, 11, 0.35);
      background: var(--accent-secondary);
    }

    button:active {
      transform: translateY(0);
    }

    button.secondary {
      background: transparent;
      border: 1px solid var(--border-medium);
      color: var(--text-secondary);
      box-shadow: none;
    }

    button.secondary:hover {
      background: rgba(240, 185, 11, 0.1);
      color: var(--accent-primary);
      border-color: var(--accent-primary);
    }

    button.danger {
      background: var(--danger);
      color: white;
      box-shadow: 0 4px 6px rgba(246, 70, 93, 0.25);
    }

    button.danger:hover {
      box-shadow: 0 6px 12px rgba(246, 70, 93, 0.35);
      background: #ff5c75;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 28px;
    }

    .form-section {
      margin-bottom: 24px;
    }

    label {
      display: block;
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }

    input[type=text], textarea, select {
      width: 100%;
      padding: 14px 16px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-medium);
      background: rgba(11, 14, 17, 0.6);
      color: var(--text-primary);
      font-size: 15px;
      transition: all 0.2s ease;
    }

    input[type=text]:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(240, 185, 11, 0.2);
    }

    .profile-preview {
      background: var(--bg-secondary);
      padding: 24px;
      border-radius: var(--radius-lg);
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: all 0.3s ease;
      width: 100%;
      border: 1px solid var(--border-light);
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
    }

    .profile-preview::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--accent-gradient);
    }

    .avatar {
      width: 140px;
      height: 140px;
      border-radius: var(--radius-lg);
      background: var(--bg-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border: 3px solid var(--border-light);
      margin-bottom: 16px;
      transition: all 0.3s ease;
    }

    .avatar:hover {
      transform: scale(1.03);
      border-color: var(--accent-primary);
    }

    .avatar-placeholder {
      color: var(--text-muted);
      font-size: 14px;
      text-align: center;
      padding: 16px;
    }

    .links {
      margin-top: 20px;
      width: 100%;
    }

    .link-item {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      align-items: center;
    }

    .link-item input {
      flex: 1;
    }

    .link-item button {
      padding: 10px 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border-medium);
      color: var(--text-secondary);
      box-shadow: none;
    }

    .link-item button:hover {
      background: var(--danger);
      color: white;
      transform: none;
    }

    .small {
      font-size: 13px;
      color: var(--text-muted);
    }

    .muted-block {
      background: rgba(240, 185, 11, 0.03);
      padding: 16px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
      margin: 20px 0;
    }

    .actions {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 24px;
    }

    footer {
      margin-top: 24px;
      display: flex;
      gap: 16px;
      justify-content: space-between;
      flex-wrap: wrap;
      padding-top: 20px;
      border-top: 1px solid var(--border-light);
    }

    .network-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .network-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }

    /* --- RESPONSIVIDADE --- */
    @media (max-width: 880px) {
      body {
        padding: 16px;
        align-items: flex-start;
      }

      .card {
        padding: 24px;
      }

      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      h1 {
        font-size: 22px;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      aside {
        order: -1;
      }

      .profile-preview {
        margin-bottom: 28px;
        padding: 20px;
      }

      .avatar {
        width: 120px;
        height: 120px;
      }

      .actions {
        flex-direction: column;
        align-items: stretch;
      }

      .actions button {
        width: 100%;
        justify-content: center;
      }

      .link-item {
        flex-direction: column;
        align-items: stretch;
      }

      .link-item button {
        width: 100%;
      }

      footer {
        justify-content: center;
        text-align: center;
      }

      /* Ajuste específico para o texto informativo em dispositivos móveis */
      .muted-block {
        order: 1;
        margin-top: 0;
        margin-bottom: 24px;
      }

      .muted-block .desktop-text {
        display: none;
      }

      .muted-block .mobile-text {
        display: block;
      }
    }

    @media (min-width: 881px) {
      .muted-block .mobile-text {
        display: none;
      }
    }

    @media (max-width: 480px) {
      .card {
        padding: 20px;
      }

      h1 {
        font-size: 20px;
      }

      input[type=text] {
        font-size: 14px;
        padding: 12px;
      }

      .muted-block {
        font-size: 12px;
      }

      button {
        font-size: 14px;
        padding: 12px;
      }

      .avatar {
        width: 100px;
        height: 100px;
      }
    }

    /* Animações */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card, .profile-preview {
      animation: fadeIn 0.5s ease-out;
    }

    /* Scrollbar personalizada */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(11, 14, 17, 0.5);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--accent-primary);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-secondary);
    }
  </style>
</head>
<body>
  <div class="card">
    <header>
      <div class="logo">
        <div class="logo-icon">L</div>
        <h1>Linkchain — Criar / Editar Perfil</h1>
      </div>
      <div class="wallet-info">
        <span id="walletAddr" class="wallet-address">não conectado</span>
        <button id="connectBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13 9H21V11H13V9ZM13 13H21V15H13V13ZM13 17H21V19H13V17ZM4 19H10V21H4C2.9 21 2 20.1 2 19V5C2 3.9 2.9 3 4 3H10V5H4V19ZM7 11H9V9H7V11ZM7 15H9V13H7V15ZM7 19H9V17H7V19Z" fill="currentColor"/>
          </svg>
          Conectar carteira
        </button>
      </div>
    </header>

    <div class="grid">
      <div>
        <div class="form-section">
          <label for="name">Nome</label>
          <input id="name" type="text" placeholder="Seu nome público (ex: @william)" />
        </div>

        <div class="form-section">
          <label for="photo">Foto (URL)</label>
          <input id="photo" type="text" placeholder="https://.../avatar.jpg" />
        </div>

        <div class="form-section" id="linksBox">
          <label>Links (rede social, site, etc.)</label>
          <div id="linksList"></div>
          <div style="margin-top:12px">
            <button id="addLinkBtn" type="button" class="secondary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z" fill="currentColor"/>
              </svg>
              Adicionar link
            </button>
          </div>
        </div>

        <!-- Bloco informativo - versão desktop -->
        <div class="muted-block small desktop-text">
          Personalize sua página e veja as mudanças ao vivo no painel à direita.
        </div>

        <div class="actions">
          <button id="saveBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M17 3H5C3.89 3 3 3.9 3 5V19C3 20.1 3.89 21 5 21H19C20.1 21 21 20.1 21 19V7L17 3ZM12 19C10.34 19 9 17.66 9 16C9 14.34 10.34 13 12 13C13.66 13 15 14.34 15 16C15 17.66 13.66 19 12 19ZM15 9H5V5H15V9Z" fill="currentColor"/>
            </svg>
            Salvar na blockchain
          </button>
          <button id="previewBtn" type="button" class="secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 4.5C7 4.5 2.73 7.61 1 12C2.73 16.39 7 19.5 12 19.5C17 19.5 21.27 16.39 23 12C21.27 7.61 17 4.5 12 4.5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z" fill="currentColor"/>
            </svg>
            Abrir página pública
          </button>
        </div>
      </div>

      <aside>
        <div class="profile-preview" id="previewBox">
          <div class="avatar">
            <div class="avatar-placeholder" id="avatarPlaceholder">Adicione uma URL de imagem</div>
            <img id="avatarImg" src="" alt="avatar" style="width:100%;height:100%;object-fit:cover;display:none"/>
          </div>
          <div style="margin-top:12px;text-align:center">
            <div id="previewName" style="font-weight:700;font-size:20px">Nome</div>
            <div id="previewAddr" class="small" style="margin-top:4px">endereço</div>
          </div>
          <div class="links" id="previewLinks"></div>
        </div>
        
        <!-- Bloco informativo - versão mobile -->
        <div class="muted-block small mobile-text">
          Personalize sua página e veja as mudanças ao vivo no painel acima.
        </div>
        
        <div style="margin-top:16px;font-size:14px;color:var(--text-secondary);font-weight:500">Link público (após salvar):</div>
        <div id="publicLink" class="small" style="word-break:break-all;margin-top:6px;padding:10px;background:rgba(240,185,11,0.03);border-radius:var(--radius-md);border:1px solid var(--border-light)">—</div>
      </aside>
    </div>

    <footer>
      <div class="network-info">
        <div class="network-indicator"></div>
        <div class="small">Rede: <span id="networkName">—</span></div>
      </div>
      <div class="small">Linkchain • DApp de Perfil Web3</div>
    </footer>
  </div>

  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.min.js";

    const CONTRACT_ADDRESS = "0xab93225dbf590478b4487bf1bf577db629aa6bee";
    const RPC_URL = "https://data-seed-prebsc-1-s1.binance.org:8545/";
    const CHAIN_ID = 97;

    const ABI = [
      "function setProfile(string calldata json) external",
      "function getProfile(address user) public view returns (string memory)",
      "event ProfileUpdated(address indexed user, string json)"
    ];

    const el = id => document.getElementById(id);
    const [
      connectBtn, walletAddrSpan, nameInput, photoInput, addLinkBtn, linksList,
      previewName, previewAddr, avatarImg, previewLinks, saveBtn,
      previewBox, networkName, previewBtn, avatarPlaceholder
    ] = [
      "connectBtn", "walletAddr", "name", "photo", "addLinkBtn", "linksList", "previewName",
      "previewAddr", "avatarImg", "previewLinks", "saveBtn", "previewBox", "networkName", "previewBtn", "avatarPlaceholder"
    ].map(el);

    let signer = null, userAddress = null;

    const isMobile = () => /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    async function switchToBSC() {
      try {
        await window.ethereum.request({ method: "wallet_switchEthereumChain", params: [{ chainId: "0x61" }] });
      } catch (error) {
        if (error.code === 4902) {
          await window.ethereum.request({
            method: "wallet_addEthereumChain",
            params: [{
              chainId: "0x61",
              chainName: "Binance Smart Chain Testnet",
              rpcUrls: [RPC_URL],
              nativeCurrency: { name: "tBNB", symbol: "tBNB", decimals: 18 },
              blockExplorerUrls: ["https://testnet.bscscan.com"]
            }]
          });
        } else console.error(error);
      }
    }

    async function tryConnect() {
      if (window.ethereum) {
        try {
          await switchToBSC();
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          const provider = new ethers.BrowserProvider(window.ethereum);
          signer = await provider.getSigner();
          userAddress = await signer.getAddress();
          walletAddrSpan.textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
          const net = await provider.getNetwork();
          networkName.textContent = net.name || "BSC Testnet";
          previewAddr.textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
          connectBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M17 7L15.59 8.41L18.17 11H8V13H18.17L15.59 15.58L17 17L22 12L17 7ZM4 5H12V3H4C2.9 3 2 3.9 2 5V19C2 20.1 2.9 21 4 21H12V19H4V5Z" fill="currentColor"/>
            </svg>
            Desconectar
          `;
          connectBtn.onclick = disconnect;
          await loadProfileOnChain(userAddress, provider);
        } catch (e) { console.error(e); }
      } else {
        if (isMobile()) {
          const deep = `https://metamask.app.link/dapp/${window.location.host}${window.location.pathname}`;
          window.location.href = deep;
        } else alert('MetaMask não encontrada.');
      }
    }

    function disconnect() {
      signer = null;
      userAddress = null;
      walletAddrSpan.textContent = 'não conectado';
      connectBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M13 9H21V11H13V9ZM13 13H21V15H13V13ZM13 17H21V19H13V17ZM4 19H10V21H4C2.9 21 2 20.1 2 19V5C2 3.9 2.9 3 4 3H10V5H4V19ZM7 11H9V9H7V11ZM7 15H9V13H7V15ZM7 19H9V17H7V19Z" fill="currentColor"/>
        </svg>
        Conectar carteira
      `;
      connectBtn.onclick = tryConnect;
    }
    connectBtn.onclick = tryConnect;

    const getLinksData = () => Array.from(linksList.querySelectorAll('.link-item'))
      .map(el => ({ label: el.children[0].value, url: el.children[1].value }))
      .filter(x => x.url);

    function renderPreview() {
      previewName.textContent = nameInput.value || 'Seu nome';
      
      // Atualizar avatar
      if (photoInput.value) {
        avatarImg.src = photoInput.value;
        avatarImg.style.display = 'block';
        avatarPlaceholder.style.display = 'none';
      } else {
        avatarImg.style.display = 'none';
        avatarPlaceholder.style.display = 'block';
      }
      
      // Atualizar links
      previewLinks.innerHTML = '';
      for (const l of getLinksData()) {
        const a = document.createElement('a');
        a.href = l.url;
        a.textContent = l.label;
        a.target = '_blank';
        a.style.color = 'var(--accent-primary)';
        a.style.display = 'block';
        a.style.margin = '8px 0';
        a.style.textDecoration = 'none';
        a.style.fontWeight = '600';
        a.style.transition = '.2s';
        a.style.padding = '8px 12px';
        a.style.borderRadius = 'var(--radius-md)';
        a.style.backgroundColor = 'rgba(240, 185, 11, 0.1)';
        a.onmouseover = () => {
          a.style.backgroundColor = 'rgba(240, 185, 11, 0.2)';
          a.style.transform = 'translateY(-2px)';
        };
        a.onmouseout = () => {
          a.style.backgroundColor = 'rgba(240, 185, 11, 0.1)';
          a.style.transform = 'translateY(0)';
        };
        previewLinks.appendChild(a);
      }
    }

    function addLinkItem(label = '', url = '') {
      const div = document.createElement('div');
      div.className = 'link-item';
      const inLabel = document.createElement('input');
      inLabel.placeholder = 'rótulo (ex: Twitter)';
      inLabel.value = label;
      const inUrl = document.createElement('input');
      inUrl.placeholder = 'https://...';
      inUrl.value = url;
      const del = document.createElement('button');
      del.innerHTML = `
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z" fill="currentColor"/>
        </svg>
      `;
      del.onclick = () => { div.remove(); renderPreview(); };
      div.append(inLabel, inUrl, del);
      linksList.appendChild(div);
      inLabel.oninput = inUrl.oninput = renderPreview;
      renderPreview();
    }

    addLinkBtn.onclick = () => addLinkItem();
    addLinkItem('Website', 'https://');

    [nameInput, photoInput].forEach(el => el.oninput = renderPreview);

    async function saveProfile() {
      if (!signer) return alert('Conecte sua carteira.');
      const profile = { name: nameInput.value, photo: photoInput.value, links: getLinksData() };
      const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
      try {
        const tx = await contract.setProfile(JSON.stringify(profile));
        alert('Confirme a transação na MetaMask.');
        await tx.wait();
        alert('Perfil salvo com sucesso na blockchain BSC!');
      } catch (e) { alert('Erro: ' + e.message); }
    }
    saveBtn.onclick = saveProfile;

    previewBtn.onclick = () => {
      if (!userAddress) return alert('Conecte sua carteira antes de abrir a página pública.');
      const url = `profile.html?addr=${userAddress}`;
      window.open(url, '_blank');
    };

    async function loadProfileOnChain(addr, provider) {
      const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
      try {
        const json = await contract.getProfile(addr);
        if (json) {
          const obj = JSON.parse(json);
          nameInput.value = obj.name || '';
          photoInput.value = obj.photo || '';
          linksList.innerHTML = '';
          (obj.links || []).forEach(l => addLinkItem(l.label, l.url));
          renderPreview();
        }
      } catch (e) { console.log(e); }
    }

    // Inicializar preview
    renderPreview();
  </script>
</body>
</html>
